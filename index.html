<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>PSY-WRITER v2 — sobre, sidebar gauche, modals</title>
<style>
  :root{
    --bg:#0f1115;
    --fg:#e9edf5;
    --muted:#a8b0bd;
    --line:rgba(255,255,255,0.14);
    --panel:rgba(255,255,255,0.06);
    --panel2:rgba(255,255,255,0.09);
    --shadow:0 18px 60px rgba(0,0,0,0.45);
    --r:16px;
    --font: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --hl: rgba(255,255,255,0.07); /* surbrillance */
    --ok: rgba(46,229,157,0.55);
    --warn: rgba(255,207,90,0.55);
    --bad: rgba(255,107,107,0.55);
  }
  [data-theme="light"]{
    --bg:#f7f8fb;
    --fg:#0d1321;
    --muted:#4b5563;
    --line:rgba(0,0,0,0.10);
    --panel:rgba(0,0,0,0.04);
    --panel2:rgba(0,0,0,0.06);
    --shadow:0 18px 60px rgba(0,0,0,0.10);
    --hl: rgba(0,0,0,0.04);
  }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--fg); font-family:var(--font)}
  header{
    position:sticky; top:0; z-index:20;
    border-bottom:1px solid var(--line);
    background:var(--bg);
  }
  .top{
    max-width:1500px; margin:0 auto; padding:12px 14px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .brand b{letter-spacing:.4px; font-weight:850}
  .brand small{display:block; color:var(--muted); font-size:12px; margin-top:2px}

  .btn{
    border:1px solid var(--line);
    background:var(--panel);
    color:var(--fg);
    padding:9px 12px;
    border-radius:999px;
    cursor:pointer;
    font-weight:650;
    user-select:none;
    transition:none;
    box-shadow:none;
  }
  .btn.ok{border-color:var(--ok)}
  .btn.warn{border-color:var(--warn)}
  .btn.bad{border-color:var(--bad)}
  .btn:active{transform:none}

  .bar{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center}

  /* Layout */
  .wrap{
    max-width:1500px; margin:0 auto; padding:14px;
    display:grid; grid-template-columns: 360px 1fr; gap:12px;
  }

  /* Sidebar visible, drawer on small screens */
  aside{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    overflow:hidden;
    min-height: calc(100vh - 92px);
  }
  .sideHead{
    padding:12px; border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .sideHead b{font-size:14px}
  .sideBody{padding:12px; overflow:auto; max-height: calc(100vh - 160px)}

  main .card{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .cardHead{
    padding:12px 14px; border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  }
  .chip{
    border:1px solid var(--line);
    background:var(--panel2);
    color:var(--muted);
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    white-space:nowrap;
  }
  .body{padding:12px 14px}

  label{display:block; color:var(--muted); font-size:12px; margin:10px 0 6px}
  input, select, textarea{
    width:100%;
    border:1px solid var(--line);
    background:rgba(0,0,0,0.10);
    color:var(--fg);
    border-radius:12px;
    padding:10px;
    font:inherit;
    outline:none;
  }
  [data-theme="light"] input, [data-theme="light"] select, [data-theme="light"] textarea{
    background:rgba(255,255,255,0.92);
  }
  textarea{min-height:130px; resize:vertical}
  .mono{font-family:var(--mono)}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .col{flex:1 1 220px; min-width:220px}

  .section{
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px;
    background:var(--hl);
    margin-top:10px;
  }
  .sectionHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px}
  .sectionHead b{font-size:13px}
  .small{color:var(--muted); font-size:12px}

  /* Checklist */
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  @media (max-width: 1050px){ .grid{grid-template-columns:1fr} }
  .chk{
    border:1px solid var(--line);
    border-radius:12px;
    padding:8px 10px;
    background:rgba(0,0,0,0.06);
    display:flex; gap:10px; align-items:flex-start;
  }
  [data-theme="light"] .chk{background:rgba(255,255,255,0.70)}
  .chk input{width:auto; margin-top:3px}
  .chk b{font-size:13px}
  .chk small{display:block; margin-top:2px; color:var(--muted); font-size:12px}

  /* Templates list */
  .tplItem{
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px;
    background:rgba(0,0,0,0.06);
    cursor:pointer;
  }
  [data-theme="light"] .tplItem{background:rgba(255,255,255,0.70)}
  .tplItem.active{outline:2px solid rgba(46,229,157,0.22)}
  .tplItem b{display:block; font-size:13px}
  .tplItem small{display:block; color:var(--muted); margin-top:3px; font-size:12px}

  /* Footer toolbar */
  .tool{
    padding:10px 14px;
    border-top:1px solid var(--line);
    background:rgba(0,0,0,0.04);
    display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
  }
  [data-theme="light"] .tool{background:rgba(255,255,255,0.55)}

  /* Modal surbrillance */
  .modalMask{
    position:fixed; inset:0; z-index:50;
    background:rgba(0,0,0,0.55);
    display:none;
    align-items:center; justify-content:center;
    padding:14px;
  }
  .modal{
    width:min(980px, 100%);
    background:var(--bg);
    border:1px solid var(--line);
    border-radius:20px;
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .modalHead{
    padding:12px 14px; border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .modalBody{padding:12px 14px; max-height:70vh; overflow:auto}
  .modal.show .modalBody{background:var(--panel)}
  .modalHead b{font-size:14px}
  .k{color:var(--muted); font-size:12px}

  /* Drawer mobile */
  .drawerMask{
    position:fixed; inset:0; z-index:60;
    background:rgba(0,0,0,0.55);
    display:none;
  }
  .drawer{
    position:fixed; top:0; left:0; z-index:61;
    width:min(380px, 92vw);
    height:100%;
    background:var(--bg);
    border-right:1px solid var(--line);
    box-shadow:var(--shadow);
    transform:translateX(-105%);
    transition: transform .15s ease;
  }
  .drawer.open{transform:translateX(0)}
  .drawer .sideBody{max-height: calc(100vh - 54px)}
  @media (max-width: 980px){
    .wrap{grid-template-columns:1fr}
    aside{display:none}
    #btnMenu{display:inline-block}
  }
  @media (min-width: 981px){
    #btnMenu{display:none}
  }
</style>
</head>

<body data-theme="dark">
<header>
  <div class="top">
    <div class="brand">
      <b>PSY-WRITER v2</b>
      <small>sobre • sidebar gauche • sous-options en surbrillance • offline</small>
    </div>
    <div class="bar">
      <button class="btn" id="btnMenu">Menu</button>
      <button class="btn" id="btnTheme">Mode clair/sombre</button>
      <button class="btn ok" id="btnGenerate">Générer</button>
      <button class="btn" id="btnCopy">Copier</button>
      <button class="btn warn" id="btnExport">Exporter</button>
      <button class="btn" id="btnImport">Importer</button>
      <button class="btn bad" id="btnReset">Reset</button>
    </div>
  </div>
</header>

<div class="wrap">
  <!-- Sidebar desktop -->
  <aside id="sideDesktop"></aside>

  <main>
    <div class="card">
      <div class="cardHead">
        <b id="docTitle">—</b>
        <div class="row" style="gap:8px">
          <span class="chip" id="chipMode">Mode : —</span>
          <span class="chip" id="chipTpl">Modèle : —</span>
        </div>
      </div>

      <div class="body" id="content"></div>

      <div class="body" id="outWrap">
        <label>Texte final (modifiable)</label>
        <textarea id="output" class="mono" style="min-height:320px"></textarea>
      </div>

      <div class="tool">
        <button class="btn ok" id="btnGenerate2">Générer</button>
        <button class="btn" id="btnCopy2">Copier</button>
        <button class="btn" id="btnDSM">DSM (surbrillance)</button>
      </div>
    </div>
  </main>
</div>

<!-- Drawer mobile -->
<div class="drawerMask" id="drawerMask"></div>
<div class="drawer" id="drawer"></div>

<!-- Modal DSM -->
<div class="modalMask" id="modalMask">
  <div class="modal" id="modal">
    <div class="modalHead">
      <b>DSM — bibliothèque clinique (non-verbatim)</b>
      <button class="btn" id="btnCloseModal">Fermer</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>

<script>
/* ===========================
   PSY-WRITER v2 — offline
   - UI: sidebar gauche + drawer mobile
   - Surbrillance: modal DSM
   - DSM: paraphrases, pas texte exact
   =========================== */

const LS="psywriter_v2_state";
const $=id=>document.getElementById(id);
const todayFR=()=>{const d=new Date();const p=n=>String(n).padStart(2,"0");return `${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()}`;}
const clean=s=>String(s||"").replace(/[ \t]+\n/g,"\n").replace(/\n{3,}/g,"\n\n").replace(/[ \t]{2,}/g," ").trim();

function sentenceJoin(a){
  a=(a||[]).map(x=>String(x||"").trim()).filter(Boolean);
  if(!a.length) return "";
  if(a.length===1) return a[0];
  if(a.length===2) return a[0]+" et "+a[1];
  return a.slice(0,-1).join(", ")+", et "+a[a.length-1];
}
function paraJoin(a){
  a=(a||[]).map(x=>String(x||"").trim()).filter(Boolean);
  return a.join(" ");
}

/* ---------------------------
   DSM-style library (paraphrases)
   IMPORTANT: pas de texte DSM exact.
   Chaque diag = "noyau" + checklist clinique + générateur de formulation.
--------------------------- */
const DSM = [
  {
    id:"mdd",
    name:"Épisode dépressif majeur (MDD)",
    core:"Humeur dépressive et/ou perte d’intérêt, avec retentissement, sur une période suffisante, non mieux expliqué par autre cause.",
    checklist:[
      {id:"mdd1", label:"Humeur dépressive", phrase:"humeur dépressive quasi quotidienne"},
      {id:"mdd2", label:"Perte d’intérêt/plaisir", phrase:"anhédonie / perte d’intérêt"},
      {id:"mdd3", label:"Sommeil", phrase:"troubles du sommeil"},
      {id:"mdd4", label:"Appétit/poids", phrase:"modification de l’appétit / du poids"},
      {id:"mdd5", label:"Énergie", phrase:"fatigue / baisse d’énergie"},
      {id:"mdd6", label:"Cognition", phrase:"difficultés d’attention / concentration"},
      {id:"mdd7", label:"Culpabilité/dévalorisation", phrase:"auto-dévalorisation / culpabilité"},
      {id:"mdd8", label:"Psychomotricité", phrase:"ralentissement ou agitation psychomotrice"},
      {id:"mdd9", label:"Idées noires", phrase:"idées noires / idéation suicidaire (à cadrer)"}
    ],
    make:(sel, free)=> clean(paraJoin([
      "Éléments compatibles avec un épisode dépressif, avec",
      sentenceJoin(sel.map(x=>x.phrase)),
      free?("("+free+")"):""
    ]))
  },
  {
    id:"gad",
    name:"Trouble anxieux généralisé (GAD)",
    core:"Anxiété excessive et difficile à contrôler, avec symptômes physiques/cognitifs, et retentissement.",
    checklist:[
      {id:"gad1", label:"Inquiétudes envahissantes", phrase:"inquiétudes envahissantes et difficiles à contrôler"},
      {id:"gad2", label:"Tension", phrase:"tension interne / irritabilité"},
      {id:"gad3", label:"Sommeil", phrase:"troubles du sommeil"},
      {id:"gad4", label:"Fatigabilité", phrase:"fatigabilité"},
      {id:"gad5", label:"Concentration", phrase:"difficultés de concentration"},
      {id:"gad6", label:"Somatique", phrase:"manifestations somatiques (tensions, douleurs, etc.)"}
    ],
    make:(sel, free)=> clean("Anxiété au premier plan, avec " + sentenceJoin(sel.map(x=>x.phrase)) + (free?(". "+free):"."))
  },
  {
    id:"panic",
    name:"Trouble panique",
    core:"Crises d’angoisse récurrentes, avec appréhension/évitemment secondaire.",
    checklist:[
      {id:"p1", label:"Crises récurrentes", phrase:"crises d’angoisse paroxystiques récurrentes"},
      {id:"p2", label:"Anxiété anticipatoire", phrase:"anxiété anticipatoire"},
      {id:"p3", label:"Évitements", phrase:"évitements et limitation des activités"},
    ],
    make:(sel, free)=> clean("Tableau de type panique, avec " + sentenceJoin(sel.map(x=>x.phrase)) + (free?(". "+free):"."))
  },
  {
    id:"ptsd",
    name:"Trouble de stress post-traumatique (PTSD)",
    core:"Après exposition à événement traumatique, symptômes intrusifs, évitement, altérations cognitivo-émotionnelles, hyperactivation, retentissement.",
    checklist:[
      {id:"t1", label:"Intrusions/cauchemars", phrase:"réexpériences intrusives (images/cauchemars)"},
      {id:"t2", label:"Évitement", phrase:"évitement des déclencheurs"},
      {id:"t3", label:"Hypervigilance", phrase:"hypervigilance / sursaut"},
      {id:"t4", label:"Humeur/cognitions", phrase:"altérations négatives des cognitions et affects"},
      {id:"t5", label:"Sommeil", phrase:"troubles du sommeil"},
    ],
    make:(sel, free)=> clean("Éléments post-traumatiques, avec " + sentenceJoin(sel.map(x=>x.phrase)) + (free?(". "+free):"."))
  },
  {
    id:"bpd",
    name:"Traits / trouble de personnalité borderline (BPD)",
    core:"Instabilité affective et relationnelle, impulsivité, image de soi fluctuante, retentissement, avec patterns répétitifs.",
    checklist:[
      {id:"b1", label:"Dysrégulation émotionnelle", phrase:"dysrégulation émotionnelle avec affects intenses"},
      {id:"b2", label:"Impulsivité", phrase:"impulsivité (comportements/consommations)"},
      {id:"b3", label:"Relations instables", phrase:"relations interpersonnelles instables"},
      {id:"b4", label:"Peur de l’abandon", phrase:"peur de l’abandon / dépendance relationnelle"},
      {id:"b5", label:"Identité fluctuante", phrase:"image de soi fluctuante"},
      {id:"b6", label:"Idées noires/auto-agirs", phrase:"idées noires et/ou auto-agirs (à cadrer)"},
    ],
    make:(sel, free)=> clean("Fonctionnement évoquant des traits borderline, avec " + sentenceJoin(sel.map(x=>x.phrase)) + (free?(". "+free):"."))
  },
  {
    id:"aud",
    name:"Trouble lié à l’usage d’alcool (AUD)",
    core:"Usage problématique avec perte de contrôle, retentissement, poursuite malgré conséquences, etc. (à objectiver).",
    checklist:[
      {id:"a1", label:"Perte de contrôle", phrase:"difficulté à contrôler l’usage"},
      {id:"a2", label:"Retentissement", phrase:"retentissement social/pro/psy"},
      {id:"a3", label:"Poursuite malgré conséquences", phrase:"poursuite malgré conséquences"},
      {id:"a4", label:"Sevrage/tolérance", phrase:"tolérance et/ou symptômes de sevrage (à préciser)"},
    ],
    make:(sel, free)=> clean("Usage d’alcool problématique, avec " + sentenceJoin(sel.map(x=>x.phrase)) + (free?(". "+free):"."))
  }
];

/* ---------------------------
   App templates (sobre)
--------------------------- */
const TEMPLATES = {
  clinical:[
    {id:"consult", name:"Note de consultation", build: buildConsult},
    {id:"follow_work", name:"Attestation suivi / travail", build: buildWorkAttest},
    {id:"evol", name:"Note d’évolution", build: buildEvol}
  ],
  email:[
    {id:"em_attach", name:"Envoi pièce jointe", subject:"Transmission du document", fields:["toName","attachment","context"], build: buildEmailAttach},
    {id:"em_resched", name:"Changement rendez-vous", subject:"Modification de rendez-vous", fields:["toName","oldDate","newDate","reason"], build: buildEmailResched},
    {id:"em_ack", name:"Bien reçu / réponse plus tard", subject:"Bien reçu", fields:["toName","topic"], build: buildEmailAck}
  ]
};

/* ---------------------------
   State
--------------------------- */
let state = {
  theme:"dark",
  mode:"clinical",            // clinical | email
  tplId:"consult",
  ui:{ identite:"", signature:"", civilite:"N" },
  data:{},                    // per tpl
  dsm:{ active:null, sel:{}, free:{} }
};

function load(){
  const raw=localStorage.getItem(LS);
  if(raw){ try{ state={...state, ...JSON.parse(raw)} }catch(e){} }
  document.body.setAttribute("data-theme", state.theme);
  ensureTpl();
  renderAll();
}
function save(){ localStorage.setItem(LS, JSON.stringify(state)); }
function ensureTpl(){
  const list = state.mode==="clinical" ? TEMPLATES.clinical : TEMPLATES.email;
  if(!list.some(t=>t.id===state.tplId)) state.tplId=list[0].id;
  state.data[state.tplId] = state.data[state.tplId] || {};
}
function v(){ ensureTpl(); return state.data[state.tplId]; }
function setV(k,val){ const vv=v(); vv[k]=val; save(); }

/* ---------------------------
   Sidebar render (desktop + drawer)
--------------------------- */
function sidebarHTML(){
  return `
    <div class="sideHead">
      <b>Paramètres</b>
      <span class="k">${todayFR()}</span>
    </div>
    <div class="sideBody">
      <label>Mode</label>
      <select id="modeSel">
        <option value="clinical">Clinique</option>
        <option value="email">Email</option>
      </select>

      <div class="section">
        <div class="sectionHead"><b>Modèles</b><span class="small" id="tplCount"></span></div>
        <input id="tplSearch" placeholder="rechercher…" />
        <div style="height:8px"></div>
        <div id="tplList"></div>
      </div>

      <div class="section">
        <div class="sectionHead"><b>Identité</b><span class="small">global</span></div>
        <label>Patient (Mme/M. …)</label>
        <input id="identite" placeholder="Mme X / M. Y / Initiales" />
        <label>Pronoms</label>
        <select id="civilite">
          <option value="F">F (elle)</option>
          <option value="M">M (il)</option>
          <option value="N">N (neutre)</option>
        </select>
        <label>Signature email</label>
        <input id="signature" placeholder="Dr … / Service …" />
      </div>

      <div class="section">
        <div class="sectionHead"><b>DSM</b><span class="small">surbrillance</span></div>
        <button class="btn" id="openDSM">Ouvrir la bibliothèque DSM</button>
        <small class="small">Je ne peux pas intégrer le texte exact DSM-5, mais j’intègre une version clinique paraphrasée + ton moteur.</small>
      </div>
    </div>
  `;
}
function mountSidebar(where){
  where.innerHTML = sidebarHTML();

  // wire
  where.querySelector("#modeSel").value = state.mode;
  where.querySelector("#modeSel").onchange = (e)=>{
    state.mode=e.target.value;
    state.tplId = (state.mode==="clinical" ? TEMPLATES.clinical[0].id : TEMPLATES.email[0].id);
    save(); renderAll();
  };

  where.querySelector("#identite").value = state.ui.identite||"";
  where.querySelector("#civilite").value = state.ui.civilite||"N";
  where.querySelector("#signature").value = state.ui.signature||"";

  where.querySelector("#identite").oninput = (e)=>{ state.ui.identite=e.target.value; save(); };
  where.querySelector("#civilite").onchange = (e)=>{ state.ui.civilite=e.target.value; save(); };
  where.querySelector("#signature").oninput = (e)=>{ state.ui.signature=e.target.value; save(); };

  const list = (state.mode==="clinical" ? TEMPLATES.clinical : TEMPLATES.email);
  const tplCount = where.querySelector("#tplCount");
  const tplList = where.querySelector("#tplList");
  const tplSearch = where.querySelector("#tplSearch");

  function renderTplList(){
    const q=(tplSearch.value||"").toLowerCase().trim();
    tplList.innerHTML="";
    const filtered = q ? list.filter(t=>t.name.toLowerCase().includes(q)) : list;
    tplCount.textContent = `${filtered.length}`;
    filtered.forEach(t=>{
      const div=document.createElement("div");
      div.className="tplItem"+(t.id===state.tplId?" active":"");
      div.innerHTML=`<b>${t.name}</b><small>${state.mode==="clinical"?"Clinique":"Email"}</small>`;
      div.onclick=()=>{ state.tplId=t.id; ensureTpl(); save(); renderAll(); };
      tplList.appendChild(div);
    });
  }
  tplSearch.oninput = renderTplList;
  renderTplList();

  where.querySelector("#openDSM").onclick = openDSMModal;
}

/* ---------------------------
   Main content
--------------------------- */
function renderMain(){
  const tpl = activeTpl();
  $("chipMode").textContent = "Mode : " + (state.mode==="clinical" ? "Clinique" : "Email");
  $("chipTpl").textContent = "Modèle : " + tpl.name;
  $("docTitle").textContent = (state.mode==="clinical" ? "Clinique" : "Email");

  if(state.mode==="clinical") renderClinicalForm();
  else renderEmailForm();

  $("output").value = generate();
}
function activeTpl(){
  const list = (state.mode==="clinical" ? TEMPLATES.clinical : TEMPLATES.email);
  return list.find(t=>t.id===state.tplId) || list[0];
}

/* ---- Clinical form: sobre + panneaux (DSM via modal) ---- */
function renderClinicalForm(){
  const vv=v();
  const html = `
    <div class="row">
      <div class="col">
        <label>Contexte (court)</label>
        <input id="ctx" placeholder="urgences, facteurs de stress, logement…" />
      </div>
      <div class="col">
        <label>Médication / plan (libre)</label>
        <input id="plan" placeholder="ex. Atarax si besoin, HDJ, groupe…" />
      </div>
    </div>

    <div class="section">
      <div class="sectionHead">
        <b>DSM — sélection clinique</b>
        <span class="small">ouvrir pour cocher</span>
      </div>
      <div class="row">
        <button class="btn" id="btnPickDx">Choisir un diagnostic (surbrillance)</button>
        <span class="chip" id="dxChip">DX : ${vv.dxName||"—"}</span>
      </div>
      <small class="small">Le DX sélectionné sert à générer une phrase clinique + liste de critères cochés (paraphrasés).</small>
    </div>

    <div class="section">
      <div class="sectionHead"><b>Examen mental (libre + rapide)</b><span class="small">style narratif</span></div>
      <textarea id="mse" class="mono" placeholder="calme, collaborant·e, humeur…, ruminations…, sécurité… + consommations."></textarea>
    </div>

    <div class="section">
      <div class="sectionHead"><b>Consommations (toujours)</b><span class="small">intégrées au texte</span></div>
      <div class="grid" id="subGrid"></div>
      <label>Complément libre</label>
      <input id="subFree" placeholder="ex. diminution récente, sport ressource…" />
    </div>
  `;
  $("content").innerHTML = html;

  $("ctx").value = vv.ctx||"";
  $("plan").value = vv.plan||"";
  $("mse").value = vv.mse||"";
  $("subFree").value = vv.subFree||"";

  $("ctx").oninput = e=>{ setV("ctx", e.target.value); $("output").value=generate(); };
  $("plan").oninput = e=>{ setV("plan", e.target.value); $("output").value=generate(); };
  $("mse").oninput = e=>{ setV("mse", e.target.value); $("output").value=generate(); };
  $("subFree").oninput = e=>{ setV("subFree", e.target.value); $("output").value=generate(); };

  // substances quick list
  const SUB = [
    {id:"alc", label:"Alcool", phrase:"usage d’alcool (souvent à visée anxiolytique)"},
    {id:"can", label:"Cannabis", phrase:"usage de cannabis"},
    {id:"stims", label:"Stimulants", phrase:"usage de stimulants"},
    {id:"bzd", label:"BZD", phrase:"usage de benzodiazépines (à préciser)"},
    {id:"cut", label:"Diminution", phrase:"diminution récente"},
    {id:"sport", label:"Ressource sport", phrase:"réinvestissement du sport comme ressource"}
  ];
  const sel = vv.subSel || [];
  const grid=$("subGrid"); grid.innerHTML="";
  SUB.forEach(it=>{
    const div=document.createElement("div");
    div.className="chk";
    div.innerHTML = `
      <input type="checkbox" ${sel.includes(it.id)?"checked":""}/>
      <div><b>${it.label}</b><small>${it.phrase}</small></div>
    `;
    div.querySelector("input").onchange = (e)=>{
      const next = e.target.checked ? [...new Set([...sel, it.id])] : sel.filter(x=>x!==it.id);
      setV("subSel", next);
      $("output").value=generate();
      renderClinicalForm(); // refresh ticks cleanly
    };
    grid.appendChild(div);
  });

  $("btnPickDx").onclick = openDSMModal;
}

/* ---- Email form ---- */
function renderEmailForm(){
  const tpl = activeTpl();
  const vv=v();

  const fields = tpl.fields || [];
  const html = `
    <div class="row">
      <div class="col">
        <label>Destinataire (nom)</label>
        <input id="toName" placeholder="Mme … / M. … / Dr …" />
      </div>
      <div class="col">
        <label>Objet</label>
        <input id="subject" />
      </div>
    </div>

    <div class="section">
      <div class="sectionHead"><b>Champs du modèle</b><span class="small">minimal</span></div>
      <div id="fields"></div>
    </div>

    <div class="section">
      <div class="sectionHead"><b>Signature</b><span class="small">global</span></div>
      <div class="small">Signature utilisée : ${state.ui.signature||"—"}</div>
    </div>
  `;
  $("content").innerHTML = html;

  $("toName").value = vv.toName||"";
  $("subject").value = vv.subject || tpl.subject;

  $("toName").oninput = e=>{ setV("toName", e.target.value); $("output").value=generate(); };
  $("subject").oninput = e=>{ setV("subject", e.target.value); $("output").value=generate(); };

  const wrap=$("fields"); wrap.innerHTML="";
  fields.forEach(f=>{
    const lab=document.createElement("label");
    lab.textContent = labelFor(f);
    const inp=document.createElement("input");
    inp.value = vv[f]||"";
    inp.placeholder = placeholderFor(f);
    inp.oninput = e=>{ setV(f, e.target.value); $("output").value=generate(); };
    wrap.appendChild(lab);
    wrap.appendChild(inp);
  });
}
function labelFor(f){
  return ({
    attachment:"Nom du document",
    context:"Contexte (optionnel)",
    oldDate:"Ancienne date",
    newDate:"Nouvelle date",
    reason:"Motif (optionnel)",
    topic:"Sujet (optionnel)"
  })[f] || f;
}
function placeholderFor(f){
  return ({
    attachment:"ex. rapport / attestation / note",
    oldDate:"ex. 25/02/2026 à 14h",
    newDate:"ex. 27/02/2026 à 09h",
    reason:"ex. contrainte d’agenda",
    topic:"ex. rendez-vous / document"
  })[f] || "";
}

/* ---------------------------
   Generators
--------------------------- */
function buildDxText(vv){
  if(!vv.dxId) return "";
  const dx = DSM.find(d=>d.id===vv.dxId);
  if(!dx) return "";
  const selIds = state.dsm.sel[dx.id] || [];
  const sel = dx.checklist.filter(x=>selIds.includes(x.id));
  const free = state.dsm.free[dx.id] || "";
  return dx.make(sel, free);
}
function buildSubText(vv){
  const SUBMAP = {
    alc:"usage d’alcool (à préciser: fréquence/quantités)",
    can:"usage de cannabis",
    stims:"usage de stimulants",
    bzd:"usage de benzodiazépines (à préciser)",
    cut:"diminution récente des consommations",
    sport:"réinvestissement d’activités ressources (sport)"
  };
  const sel = vv.subSel || [];
  const parts = sel.map(id=>SUBMAP[id]).filter(Boolean);
  const free = (vv.subFree||"").trim();
  if(!parts.length && !free) return "non documenté";
  return sentenceJoin(parts) + (free ? (parts.length?(", "+free):free) : "");
}

function generate(){
  const tpl = activeTpl();
  const vv = v();
  if(state.mode==="clinical") return tpl.build(vv);
  else return tpl.build(vv);
}

/* Clinical builds */
function buildConsult(vv){
  const ident = state.ui.identite || "la personne";
  const ctx = (vv.ctx||"").trim();
  const dxTxt = buildDxText(vv);
  const mse = (vv.mse||"").trim();
  const sub = buildSubText(vv);
  const plan = (vv.plan||"").trim();

  const parts = [];
  parts.push(`Consultation psychiatrique — ${todayFR()}`);
  parts.push("");
  if(ctx) parts.push(`Contexte : ${ctx}`);
  parts.push(`Je vois ${ident} en consultation dans le cadre d’un suivi.`);
  if(dxTxt) parts.push(`Sur le plan clinique, ${dxTxt}`);
  if(mse) parts.push(`À l’examen mental : ${mse}`);
  parts.push(`Sur le plan des consommations : ${sub}.`);
  if(plan) parts.push(`Plan : ${plan}`);
  return clean(parts.join("\n"));
}

function buildWorkAttest(vv){
  const ident = state.ui.identite || "la personne";
  const ctx = (vv.ctx||"").trim();
  const dxTxt = buildDxText(vv);
  const mse = (vv.mse||"").trim();
  const sub = buildSubText(vv);
  const plan = (vv.plan||"").trim();

  const parts = [];
  parts.push("Attestation médicale");
  parts.push("");
  parts.push(`Je vois en consultation de psychiatrie ${ident} de manière régulière.`);
  if(dxTxt) parts.push(`Le tableau clinique est compatible avec : ${dxTxt}`);
  if(ctx) parts.push(`Contexte : ${ctx}`);
  if(mse) parts.push(`Éléments cliniques actuels : ${mse}`);
  parts.push(`Consommations : ${sub}.`);
  if(plan) parts.push(`Prise en charge : ${plan}`);
  parts.push("À ce stade, l’état clinique actuel n’est pas encore compatible avec une reprise d’activité professionnelle. Une réévaluation sera réalisée en fonction de l’évolution.");
  parts.push("");
  parts.push(`Fait pour servir et valoir ce que de droit. — ${todayFR()}`);
  return clean(parts.join("\n"));
}

function buildEvol(vv){
  const ident = state.ui.identite || "la personne";
  const ctx = (vv.ctx||"").trim();
  const dxTxt = buildDxText(vv);
  const mse = (vv.mse||"").trim();
  const sub = buildSubText(vv);
  const plan = (vv.plan||"").trim();

  const parts=[];
  parts.push(`Note d’évolution — ${todayFR()}`);
  parts.push(`Patient·e : ${ident}`);
  parts.push("");
  if(ctx) parts.push(`Contexte/évolution : ${ctx}`);
  if(dxTxt) parts.push(`Clinique : ${dxTxt}`);
  if(mse) parts.push(`Examen mental : ${mse}`);
  parts.push(`Consommations : ${sub}.`);
  if(plan) parts.push(`Plan : ${plan}`);
  return clean(parts.join("\n"));
}

/* Email builds */
function buildEmailAttach(vv){
  const to = (vv.toName||"").trim();
  const subj = (vv.subject||"Transmission du document").trim();
  const attach = (vv.attachment||"le document demandé").trim();
  const ctx = (vv.context||"").trim();
  const sig = state.ui.signature || "";
  return clean(`Objet : ${subj}

Bonjour ${to},

Veuillez trouver en pièce jointe ${attach}.
${ctx?("\n"+ctx+"\n"):""}

Bien à vous,
${sig}`);
}
function buildEmailResched(vv){
  const to=(vv.toName||"").trim();
  const subj=(vv.subject||"Modification de rendez-vous").trim();
  const oldD=(vv.oldDate||"__").trim();
  const newD=(vv.newDate||"__").trim();
  const reason=(vv.reason||"").trim();
  const sig=state.ui.signature||"";
  return clean(`Objet : ${subj}

Bonjour ${to},

Je reviens vers vous concernant le rendez-vous prévu le ${oldD}.
Je vous propose de le déplacer au ${newD}.
${reason?("\nMotif : "+reason+"\n"):""}

Merci de me confirmer si cela vous convient.

Bien à vous,
${sig}`);
}
function buildEmailAck(vv){
  const to=(vv.toName||"").trim();
  const subj=(vv.subject||"Bien reçu").trim();
  const topic=(vv.topic||"").trim();
  const sig=state.ui.signature||"";
  return clean(`Objet : ${subj}

Bonjour ${to},

Bien reçu pour votre message${topic?(" concernant "+topic):""}.
Je prends note et je reviens vers vous dès que possible.

Bien à vous,
${sig}`);
}

/* ---------------------------
   DSM modal (surbrillance)
--------------------------- */
function openDSMModal(){
  $("modalMask").style.display="flex";
  renderDSMModal();
}
function closeDSMModal(){
  $("modalMask").style.display="none";
}
$("btnCloseModal").onclick = closeDSMModal;
$("modalMask").addEventListener("click",(e)=>{
  if(e.target.id==="modalMask") closeDSMModal();
});

function renderDSMModal(){
  const vv=v();
  const html = `
    <div class="row">
      <div class="col">
        <label>Recherche diagnostic</label>
        <input id="dxSearch" placeholder="dépression, anxiété, PTSD, borderline…" />
      </div>
      <div class="col">
        <label>Diagnostic sélectionné (pour ce document)</label>
        <select id="dxPick"></select>
      </div>
    </div>

    <div class="section">
      <div class="sectionHead"><b>Résumé</b><span class="small">clinique</span></div>
      <div class="small" id="dxCore">—</div>
    </div>

    <div class="section">
      <div class="sectionHead"><b>Checklist (paraphrasée)</b><span class="small">multi</span></div>
      <div class="grid" id="dxGrid"></div>
      <label>Complément libre</label>
      <input id="dxFree" placeholder="nuance, chronologie, retentissement, facteurs…" />
    </div>

    <div class="section">
      <div class="sectionHead"><b>Formulation générée</b><span class="small">aperçu</span></div>
      <textarea id="dxPreview" class="mono" style="min-height:140px"></textarea>
    </div>

    <div class="row">
      <button class="btn ok" id="dxApply">Appliquer au document</button>
      <button class="btn" id="dxClear">Effacer sélection</button>
    </div>
  `;
  $("modalBody").innerHTML = html;

  const dxPick=$("dxPick");
  DSM.forEach(d=>{
    const o=document.createElement("option");
    o.value=d.id; o.textContent=d.name;
    dxPick.appendChild(o);
  });
  dxPick.value = vv.dxId || DSM[0].id;

  const dxSearch=$("dxSearch");
  dxSearch.oninput = ()=>{
    const q=(dxSearch.value||"").toLowerCase().trim();
    dxPick.innerHTML="";
    DSM.filter(d=>d.name.toLowerCase().includes(q) || d.core.toLowerCase().includes(q)).forEach(d=>{
      const o=document.createElement("option");
      o.value=d.id; o.textContent=d.name;
      dxPick.appendChild(o);
    });
    if(dxPick.options.length) dxPick.value = dxPick.options[0].value;
    renderDxPane(dxPick.value);
  };

  dxPick.onchange = ()=> renderDxPane(dxPick.value);
  renderDxPane(dxPick.value);

  $("dxApply").onclick = ()=>{
    const id = dxPick.value;
    const d = DSM.find(x=>x.id===id);
    setV("dxId", id);
    setV("dxName", d?d.name:"—");
    $("output").value = generate();
    renderAll();
    closeDSMModal();
  };

  $("dxClear").onclick = ()=>{
    setV("dxId", "");
    setV("dxName", "");
    $("output").value = generate();
    renderAll();
    closeDSMModal();
  };
}

function renderDxPane(dxId){
  const d = DSM.find(x=>x.id===dxId);
  if(!d) return;
  $("dxCore").textContent = d.core;

  // load selections
  state.dsm.sel[d.id] = state.dsm.sel[d.id] || [];
  state.dsm.free[d.id] = state.dsm.free[d.id] || "";
  const selIds = state.dsm.sel[d.id];

  const grid=$("dxGrid");
  grid.innerHTML="";
  d.checklist.forEach(it=>{
    const div=document.createElement("div");
    div.className="chk";
    div.innerHTML = `
      <input type="checkbox" ${selIds.includes(it.id)?"checked":""}/>
      <div><b>${it.label}</b><small>${it.phrase}</small></div>
    `;
    div.querySelector("input").onchange = (e)=>{
      const next = e.target.checked ? [...new Set([...selIds, it.id])] : selIds.filter(x=>x!==it.id);
      state.dsm.sel[d.id]=next;
      save();
      updateDxPreview(d);
    };
    grid.appendChild(div);
  });

  $("dxFree").value = state.dsm.free[d.id] || "";
  $("dxFree").oninput = (e)=>{
    state.dsm.free[d.id]=e.target.value;
    save();
    updateDxPreview(d);
  };

  updateDxPreview(d);
}

function updateDxPreview(d){
  const selIds = state.dsm.sel[d.id] || [];
  const sel = d.checklist.filter(x=>selIds.includes(x.id));
  const free = state.dsm.free[d.id] || "";
  $("dxPreview").value = d.make(sel, free);
}

/* ---------------------------
   Export/Import/Reset
--------------------------- */
function exportState(){
  const blob=new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`psywriter-v2-${Date.now()}.json`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 2500);
}
function importState(){
  const inp=document.createElement("input");
  inp.type="file"; inp.accept="application/json";
  inp.onchange=async()=>{
    const f=inp.files[0]; if(!f) return;
    try{
      const txt=await f.text();
      state={...state, ...JSON.parse(txt)};
      save();
      document.body.setAttribute("data-theme", state.theme);
      ensureTpl();
      renderAll();
      alert("Import OK.");
    }catch(e){ alert("Import invalide : "+e.message); }
  };
  inp.click();
}
function resetAll(){
  if(!confirm("Reset complet ?")) return;
  localStorage.removeItem(LS);
  location.reload();
}

/* ---------------------------
   Copy
--------------------------- */
function copyOutput(){
  $("output").select();
  document.execCommand("copy");
}

/* ---------------------------
   Drawer mobile
--------------------------- */
function openDrawer(){
  $("drawerMask").style.display="block";
  $("drawer").classList.add("open");
}
function closeDrawer(){
  $("drawerMask").style.display="none";
  $("drawer").classList.remove("open");
}
$("drawerMask").onclick = closeDrawer;

/* ---------------------------
   Render all
--------------------------- */
function renderAll(){
  // Mount sidebar desktop and drawer
  $("sideDesktop").innerHTML="";
  mountSidebar($("sideDesktop"));

  $("drawer").innerHTML = sidebarHTML();
  mountSidebar($("drawer"));

  // fix drawer close on template click in mobile
  // (simple: close on any click in drawer list)
  $("drawer").addEventListener("click",(e)=>{
    if(e.target.closest(".tplItem") || e.target.id==="openDSM") closeDrawer();
  });

  renderMain();

  // dx chip update
  const vv=v();
  const dxChip=document.getElementById("dxChip");
  if(dxChip) dxChip.textContent = "DX : " + (vv.dxName||"—");
}

/* ---------------------------
   Header buttons
--------------------------- */
$("btnTheme").onclick = ()=>{
  state.theme = (state.theme==="dark" ? "light" : "dark");
  document.body.setAttribute("data-theme", state.theme);
  save();
};
$("btnGenerate").onclick = ()=> $("output").value = generate();
$("btnGenerate2").onclick = ()=> $("output").value = generate();
$("btnCopy").onclick = copyOutput;
$("btnCopy2").onclick = copyOutput;
$("btnExport").onclick = exportState;
$("btnImport").onclick = importState;
$("btnReset").onclick = resetAll;
$("btnDSM").onclick = openDSMModal;

$("btnMenu").onclick = openDrawer;

/* Init */
load();
</script>
</body>
</html>
